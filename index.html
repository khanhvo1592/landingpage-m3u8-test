<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test M3U8 Player</title>
  <style>
    :root {
      --primary-color: #4caf50;
      --primary-dark: #3b8c3e;
      --error-color: #f44336;
      --dark-bg: #121212;
      --card-bg: #1e1e1e;
      --light-text: #fafafa;
      --secondary-text: #bbbbbb;
      --border-color: #333;
      --input-bg: #2c2c2c;
      --hover-bg: #2a2a2a;
      --header-height: 60px;
      --container-width: 1000px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--dark-bg);
      color: var(--light-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: var(--spacing-md);
      width: 100%;
    }

    header {
      background-color: var(--card-bg);
      padding: var(--spacing-md);
      text-align: center;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1, h2, h3 {
      margin-bottom: var(--spacing-md);
      font-weight: 500;
    }

    h1 {
      font-size: 1.75rem;
    }

    h2 {
      font-size: 1.5rem;
      margin-top: var(--spacing-lg);
    }

    h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-sm);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow);
    }

    .player-container {
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      position: relative;
    }

    input, button, select {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 1rem;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--light-text);
    }

    input {
      flex: 1;
      min-width: 200px;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      white-space: nowrap;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    button:active {
      transform: translateY(1px);
    }

    button.secondary {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
    }

    button.secondary:hover {
      background-color: var(--hover-bg);
    }

    button.danger {
      background-color: var(--error-color);
    }

    button.small {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.85rem;
    }

    video {
      width: 100%;
      border-radius: var(--border-radius-md);
      background-color: #000;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .url-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      width: 100%;
    }

    .history-container {
      width: 100%;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
      border-radius: var(--border-radius-sm);
      background-color: var(--input-bg);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item:hover {
      background-color: var(--hover-bg);
    }

    .history-url {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
      cursor: pointer;
      color: var(--secondary-text);
    }

    .history-url:hover {
      color: var(--light-text);
      text-decoration: underline;
    }

    .history-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .settings-container {
      width: 100%;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-label {
      font-weight: 500;
    }

    .error-container {
      width: 100%;
      padding: var(--spacing-md);
      background-color: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--error-color);
      border-radius: var(--border-radius-md);
      color: #ff9c9c;
      display: none;
      margin-top: var(--spacing-md);
    }

    .error-container pre {
      margin-top: var(--spacing-sm);
      background-color: rgba(0, 0, 0, 0.2);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      overflow-x: auto;
      font-size: 0.85rem;
    }

    .error-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .error-solution {
      background-color: rgba(255, 255, 255, 0.05);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      margin-top: var(--spacing-sm);
      font-size: 0.9rem;
    }

    .error-solution ul {
      margin-left: var(--spacing-md);
      margin-top: var(--spacing-xs);
    }

    .recovery-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: orange;
      margin-right: 5px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--spacing-md);
      overflow-x: auto;
    }

    .tab {
      padding: var(--spacing-sm) var(--spacing-md);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      font-weight: 500;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    .tab-content {
      display: none;
      width: 100%;
    }

    .tab-content.active {
      display: block;
    }

    .stream-quality {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--input-bg);
      border-radius: var(--border-radius-sm);
    }

    .stream-quality p {
      margin-bottom: var(--spacing-xs);
    }

    .player-clock {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      font-size: 0.9rem;
      z-index: 5;
      font-family: monospace;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .player-clock .clock-icon {
      opacity: 0.8;
      font-size: 0.8rem;
    }

    footer {
      text-align: center;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-md);
      color: var(--secondary-text);
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      .url-controls {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .controls {
        flex-direction: column;
      }
      
      input {
        width: 100%;
      }
      
      .history-actions {
        flex-wrap: wrap;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Trình phát M3U8 - Test URL</h1>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="controls">
        <div class="url-controls">
          <input type="text" id="m3u8-url" placeholder="Dán URL .m3u8 vào đây" />
          <button onclick="loadStream()">Phát</button>
          <button class="secondary" onclick="copyUrl()">Sao chép</button>
          <button class="secondary" onclick="toggleSettings()">Cài đặt</button>
        </div>
      </div>
      
      <div class="player-container">
        <video id="video" controls></video>
        <div class="player-clock">
          <span class="clock-icon">⏱</span>
          <span id="vn-clock">--:--:--</span>
        </div>
      </div>
    </div>

    <div class="error-container" id="error-container">
      <h3>Lỗi phát sinh:</h3>
      <div id="error-details"></div>
      <div class="error-solution" id="error-solution"></div>
      <div class="error-actions">
        <button onclick="recoverStream()">Thử khắc phục</button>
        <button class="secondary" onclick="changeSettings()">Đổi cài đặt</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('history')">Lịch sử</div>
      <div class="tab" onclick="switchTab('info')">Thông tin Stream</div>
      <div class="tab" onclick="switchTab('settings')">Cài đặt</div>
    </div>

    <div class="tab-content active" id="history-tab">
      <div class="card history-container">
        <div class="history-header">
          <h3>Lịch sử URL</h3>
          <button class="danger small" onclick="clearHistory()">Xóa lịch sử</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <div class="tab-content" id="info-tab">
      <div class="card history-container">
        <h3>Thông tin Stream</h3>
        <div id="stream-info">
          <p>Chưa có thông tin stream nào được tải.</p>
        </div>
      </div>
    </div>

    <div class="tab-content" id="settings-tab">
      <div class="card settings-container">
        <h3>Cài đặt</h3>
        <div class="setting-row">
          <span class="setting-label">Tự động phát</span>
          <input type="checkbox" id="autoplay-setting" checked>
        </div>
        <div class="setting-row">
          <span class="setting-label">Lưu lịch sử</span>
          <input type="checkbox" id="save-history-setting" checked>
        </div>
        <div class="setting-row">
          <span class="setting-label">Phiên bản HLS.js</span>
          <select id="hls-version">
            <option value="latest">Latest</option>
            <option value="1.4.10">1.4.10</option>
            <option value="1.3.5">1.3.5</option>
            <option value="1.2.9">1.2.9</option>
          </select>
        </div>
      </div>
    </div>
    
    <footer>
      Công cụ phát triển & kiểm tra URL M3U8 by khanhvo1592@gmail.com
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    let currentHls = null;
    
    // Khởi tạo cài đặt
    let settings = {
      autoplay: true,
      saveHistory: true,
      hlsVersion: 'latest'
    };
    
    // Khởi tạo lịch sử
    let history = JSON.parse(localStorage.getItem('m3u8History')) || [];
    
    // Đồng hồ Việt Nam
    function updateClock() {
      const now = new Date();
      // Chuyển đổi sang múi giờ Việt Nam (UTC+7)
      const vnTime = new Date(now.getTime() + (7 * 60 * 60 * 1000 - now.getTimezoneOffset() * 60 * 1000));
      
      const hours = vnTime.getHours().toString().padStart(2, '0');
      const minutes = vnTime.getMinutes().toString().padStart(2, '0');
      const seconds = vnTime.getSeconds().toString().padStart(2, '0');
      
      document.getElementById('vn-clock').textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    // Cập nhật đồng hồ mỗi giây
    setInterval(updateClock, 1000);
    updateClock(); // Cập nhật ngay lập tức
    
    // Hiển thị lịch sử
    function renderHistory() {
      const historyList = document.getElementById('history-list');
      historyList.innerHTML = '';
      
      if (history.length === 0) {
        historyList.innerHTML = '<p style="padding: 10px;">Chưa có URL nào trong lịch sử.</p>';
        return;
      }
      
      history.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        const urlSpan = document.createElement('div');
        urlSpan.className = 'history-url';
        urlSpan.textContent = url;
        urlSpan.title = url;
        urlSpan.onclick = () => {
          document.getElementById('m3u8-url').value = url;
          loadStream();
        };
        
        const actions = document.createElement('div');
        actions.className = 'history-actions';
        
        const playBtn = document.createElement('button');
        playBtn.className = 'small';
        playBtn.textContent = 'Phát';
        playBtn.onclick = () => {
          document.getElementById('m3u8-url').value = url;
          loadStream();
        };
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'small secondary';
        copyBtn.textContent = 'Sao chép';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(url);
        };
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'small danger';
        removeBtn.textContent = 'Xóa';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          history.splice(index, 1);
          saveHistory();
          renderHistory();
        };
        
        actions.appendChild(playBtn);
        actions.appendChild(copyBtn);
        actions.appendChild(removeBtn);
        
        item.appendChild(urlSpan);
        item.appendChild(actions);
        historyList.appendChild(item);
      });
    }
    
    // Lưu lịch sử
    function saveHistory() {
      localStorage.setItem('m3u8History', JSON.stringify(history));
    }
    
    // Thêm URL vào lịch sử
    function addToHistory(url) {
      if (!settings.saveHistory) return;
      
      // Xóa URL này nếu đã tồn tại
      history = history.filter(item => item !== url);
      
      // Thêm vào đầu danh sách
      history.unshift(url);
      
      // Giới hạn số lượng URL trong lịch sử
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      saveHistory();
      renderHistory();
    }
    
    // Xóa toàn bộ lịch sử
    function clearHistory() {
      if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử không?')) {
        history = [];
        saveHistory();
        renderHistory();
      }
    }
    
    // Sao chép URL vào clipboard
    function copyUrl() {
      const url = document.getElementById('m3u8-url').value.trim();
      if (url) {
        copyToClipboard(url);
      } else {
        alert('Không có URL để sao chép!');
      }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          alert('Đã sao chép URL vào clipboard!');
        })
        .catch(err => {
          console.error('Không thể sao chép URL: ', err);
          alert('Không thể sao chép URL. Vui lòng thử lại.');
        });
    }
    
    // Hiển thị/ẩn cài đặt
    function toggleSettings() {
      switchTab('settings');
    }
    
    // Cập nhật cài đặt
    function updateSettings() {
      settings.autoplay = document.getElementById('autoplay-setting').checked;
      settings.saveHistory = document.getElementById('save-history-setting').checked;
      settings.hlsVersion = document.getElementById('hls-version').value;
      
      localStorage.setItem('m3u8Settings', JSON.stringify(settings));
      
      // Cập nhật thư viện HLS.js nếu phiên bản thay đổi
      if (settings.hlsVersion !== 'latest') {
        const script = document.querySelector('script[src*="hls.js"]');
        script.src = `https://cdn.jsdelivr.net/npm/hls.js@${settings.hlsVersion}`;
      }
    }
    
    // Tải cài đặt từ localStorage
    function loadSettings() {
      const savedSettings = JSON.parse(localStorage.getItem('m3u8Settings'));
      if (savedSettings) {
        settings = {...settings, ...savedSettings};
      }
      
      document.getElementById('autoplay-setting').checked = settings.autoplay;
      document.getElementById('save-history-setting').checked = settings.saveHistory;
      document.getElementById('hls-version').value = settings.hlsVersion;
    }
    
    // Hiển thị thông tin lỗi
    function showError(title, details) {
      const errorContainer = document.getElementById('error-container');
      const errorDetails = document.getElementById('error-details');
      const errorSolution = document.getElementById('error-solution');
      
      errorContainer.style.display = 'block';
      errorDetails.innerHTML = `<p><strong>${title}</strong></p>`;
      
      if (details) {
        errorDetails.innerHTML += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
      }

      // Hiển thị gợi ý giải pháp dựa trên loại lỗi
      let solutionHtml = '';
      
      if (details && details.type === 'mediaError') {
        solutionHtml = `
          <p><strong>Giải pháp có thể:</strong></p>
          <ul>
            <li>Kiểm tra lại URL stream (có thể URL đã hết hạn)</li>
            <li>Kiểm tra kết nối mạng của bạn</li>
            <li>Stream có thể yêu cầu quyền truy cập (CORS/cookie)</li>
            <li>Thử chuyển sang phiên bản HLS.js khác</li>
            <li>Liên hệ quản trị viên nếu đây là stream nội bộ</li>
          </ul>
        `;
        
        // Tự động thử khôi phục với lỗi media
        setTimeout(() => recoverStream(), 2000);
      } else if (details && details.type === Hls.ErrorTypes.NETWORK_ERROR) {
        solutionHtml = `
          <p><strong>Giải pháp có thể:</strong></p>
          <ul>
            <li>Kiểm tra kết nối internet của bạn</li>
            <li>Kiểm tra URL có chính xác không</li>
            <li>Server stream có thể đang quá tải</li>
            <li>Có thể stream yêu cầu xác thực</li>
            <li>Thử truy cập vào URL trực tiếp để xem lỗi chi tiết</li>
          </ul>
        `;
      } else {
        solutionHtml = `
          <p><strong>Giải pháp chung:</strong></p>
          <ul>
            <li>Làm mới trang và thử lại</li>
            <li>Kiểm tra URL stream có đúng định dạng .m3u8 không</li>
            <li>Thử mở stream trên các trình phát khác</li>
          </ul>
        `;
      }
      
      errorSolution.innerHTML = solutionHtml;
    }
    
    // Ẩn thông tin lỗi
    function hideError() {
      document.getElementById('error-container').style.display = 'none';
    }

    // Mở tab cài đặt
    function changeSettings() {
      switchTab('settings');
    }

    // Thử khắc phục stream
    let recoveryAttempts = 0;
    const MAX_RECOVERY_ATTEMPTS = 3;

    function recoverStream() {
      const url = document.getElementById('m3u8-url').value.trim();
      if (!url) return;
      
      if (recoveryAttempts >= MAX_RECOVERY_ATTEMPTS) {
        showError("Đã thử khắc phục nhiều lần không thành công", 
          {message: "Vui lòng kiểm tra lại URL hoặc thử các cài đặt khác"});
        recoveryAttempts = 0;
        return;
      }
      
      recoveryAttempts++;
      
      // Thêm indicator đang khôi phục
      const errorDetails = document.getElementById('error-details');
      errorDetails.innerHTML += `
        <p style="margin-top: 10px;">
          <span class="recovery-indicator"></span>
          Đang thử khắc phục lần ${recoveryAttempts}/${MAX_RECOVERY_ATTEMPTS}...
        </p>
      `;
      
      // Hủy instance hiện tại
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      // Khởi tạo lại với cài đặt khác
      const hlsConfig = {
        debug: true,
        // Các cài đặt để tăng khả năng phục hồi
        maxBufferLength: 30,
        maxMaxBufferLength: 60,
        maxBufferSize: 60 * 1000 * 1000, // 60MB
        maxBufferHole: 0.5,
        lowLatencyMode: false,
        // Số lần thử lại
        manifestLoadingMaxRetry: 6,
        manifestLoadingRetryDelay: 1000,
        levelLoadingMaxRetry: 6,
        levelLoadingRetryDelay: 1000,
        fragLoadingMaxRetry: 6,
        fragLoadingRetryDelay: 1000
      };
      
      try {
        if (Hls.isSupported()) {
          const hls = new Hls(hlsConfig);
          currentHls = hls;
          
          hls.loadSource(url);
          hls.attachMedia(video);
          
          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            hideError();
            recoveryAttempts = 0;
            
            if (settings.autoplay) {
              video.play().catch(e => {
                console.warn('Không thể tự động phát: ', e);
              });
            }
            
            updateStreamInfo(hls.manifest);
          });
          
          // Xử lý sự kiện phục hồi lỗi media
          hls.on(Hls.Events.ERROR, function (event, data) {
            console.error('HLS error during recovery:', data);
            
            // Thử phục hồi lỗi media tự động
            if (data.fatal && data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              if (data.details === Hls.ErrorDetails.BUFFER_APPEND_ERROR) {
                console.log('Trying to recover from buffer append error...');
                hls.recoverMediaError();
              } else {
                console.log('Trying to recover from media error...');
                hls.recoverMediaError();
              }
            }
            
            // Nếu lỗi mạng nghiêm trọng và đã hết số lần thử, hiển thị lỗi
            if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR && recoveryAttempts >= MAX_RECOVERY_ATTEMPTS) {
              let errorMsg = 'Lỗi mạng khi tải stream.';
              let details = {
                type: data.type,
                details: data.details,
                url: data.context ? data.context.url : 'unknown',
                response: data.response ? 
                  { code: data.response.code, text: data.response.text } : 'Không có phản hồi'
              };
              
              showError(errorMsg, details);
            }
          });

          // Thêm báo cáo phục hồi thành công
          hls.on(Hls.Events.FRAG_LOADED, function() {
            if (recoveryAttempts > 0) {
              hideError();
              recoveryAttempts = 0;
            }
          });
        }
      } catch (e) {
        console.error('Error during recovery:', e);
        showError('Lỗi không thể khắc phục', {message: e.message});
      }
    }
    
    // Bắt sự kiện thay đổi cài đặt
    document.getElementById('autoplay-setting').addEventListener('change', updateSettings);
    document.getElementById('save-history-setting').addEventListener('change', updateSettings);
    document.getElementById('hls-version').addEventListener('change', updateSettings);
    
    // Khởi tạo
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      renderHistory();
      
      // Kiểm tra URL trong hash (nếu có)
      const hashUrl = window.location.hash.slice(1);
      if (hashUrl) {
        try {
          const decodedUrl = decodeURIComponent(hashUrl);
          document.getElementById('m3u8-url').value = decodedUrl;
          loadStream();
        } catch (e) {
          console.error('Không thể giải mã URL từ hash:', e);
        }
      }

      // Bắt sự kiện nhấn Enter trong input
      document.getElementById('m3u8-url').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
          loadStream();
        }
      });
    });
    
    // Cập nhật hash khi tải stream
    function updateUrlHash(url) {
      if (url) {
        window.location.hash = encodeURIComponent(url);
      }
    }

    // Chuyển đổi tab
    function switchTab(tabName) {
      // Xóa trạng thái active cho tất cả tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Thêm active cho tab được chọn
      document.querySelector(`.tab:nth-child(${tabName === 'history' ? 1 : (tabName === 'info' ? 2 : 3)})`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Cập nhật thông tin stream
    function updateStreamInfo(manifest) {
      const streamInfo = document.getElementById('stream-info');
      
      if (!manifest || !manifest.levels) {
        streamInfo.innerHTML = '<p>Không có thông tin stream.</p>';
        return;
      }
      
      let infoHTML = '<div>';
      
      infoHTML += `<p><strong>Số lượng chất lượng:</strong> ${manifest.levels.length}</p>`;
      
      manifest.levels.forEach((level, index) => {
        infoHTML += `
          <div class="stream-quality">
            <p><strong>Chất lượng #${index + 1}:</strong></p>
            <p>Độ phân giải: ${level.width}x${level.height}</p>
            <p>Bitrate: ${Math.round(level.bitrate / 1000)} kbps</p>
            <p>Codec: ${level.codecSet || 'Không rõ'}</p>
          </div>
        `;
      });
      
      infoHTML += '</div>';
      streamInfo.innerHTML = infoHTML;
    }

    function loadStream() {
      // Hủy instance HLS hiện tại nếu có
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      // Reset số lần thử khôi phục
      recoveryAttempts = 0;
      
      const url = document.getElementById('m3u8-url').value.trim();
      if (!url) {
        alert('Vui lòng nhập URL .m3u8');
        return;
      }
      
      // Ẩn thông báo lỗi cũ
      hideError();
      
      // Cập nhật thông tin stream
      document.getElementById('stream-info').innerHTML = '<p>Đang tải thông tin stream...</p>';
      
      // Thêm vào lịch sử
      addToHistory(url);
      
      // Cập nhật hash
      updateUrlHash(url);

      if (Hls.isSupported()) {
        const hls = new Hls({
          debug: true,
          // Các cài đặt mặc định cho trình phát
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          manifestLoadingMaxRetry: 4,
          manifestLoadingRetryDelay: 1000
        });
        
        currentHls = hls;
        hls.loadSource(url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
          if (settings.autoplay) {
            video.play().catch(e => {
              console.warn('Không thể tự động phát: ', e);
              showError('Không thể tự động phát', 
                'Trình duyệt chặn tự động phát. Hãy nhấn nút play trên video để bắt đầu.');
            });
          }
          
          updateStreamInfo(hls.manifest);
        });
        
        hls.on(Hls.Events.ERROR, function (event, data) {
          console.error('HLS error:', data);
          
          let errorMsg = 'Không thể phát luồng HLS.';
          let details = null;
          
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                errorMsg = 'Lỗi mạng khi tải stream.';
                details = {
                  type: data.type,
                  details: data.details,
                  url: data.context ? data.context.url : 'unknown',
                  response: data.response ? 
                    { code: data.response.code, text: data.response.text } : 'Không có phản hồi'
                };
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                errorMsg = 'Lỗi media. Stream không hợp lệ hoặc bị hỏng.';
                details = {
                  type: 'mediaError',
                  details: data.details
                };
                break;
              default:
                errorMsg = 'Lỗi không xác định.';
                details = {
                  type: data.type,
                  details: data.details
                };
                break;
            }
            
            showError(errorMsg, details);
            
            // Tự động thử khôi phục lỗi media
            if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              console.log('Trying to recover from media error...');
              hls.recoverMediaError();
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', function () {
          if (settings.autoplay) {
            video.play();
          }
          document.getElementById('stream-info').innerHTML = 
            '<p>Đang sử dụng trình phát HLS tích hợp trình duyệt. Thông tin chi tiết không khả dụng.</p>';
        });
        
        video.addEventListener('error', function(e) {
          console.error('Video error:', video.error);
          showError('Không thể phát video', {
            code: video.error ? video.error.code : 'Không rõ',
            message: video.error ? video.error.message : 'Không rõ'
          });
        });
      } else {
        showError('Trình duyệt không hỗ trợ HLS.');
      }
    }
  </script>
</body>
</html>
