<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test M3U8 Player</title>
  <style>
    :root {
      --primary-color: #4caf50;
      --primary-dark: #3b8c3e;
      --error-color: #f44336;
      --dark-bg: #121212;
      --card-bg: #1e1e1e;
      --light-text: #fafafa;
      --secondary-text: #bbbbbb;
      --border-color: #333;
      --input-bg: #2c2c2c;
      --hover-bg: #2a2a2a;
      --header-height: 60px;
      --container-width: 1000px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--dark-bg);
      color: var(--light-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: var(--spacing-md);
      width: 100%;
    }

    header {
      background-color: var(--card-bg);
      padding: var(--spacing-md);
      text-align: center;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1, h2, h3 {
      margin-bottom: var(--spacing-md);
      font-weight: 500;
    }

    h1 {
      font-size: 1.75rem;
    }

    h2 {
      font-size: 1.5rem;
      margin-top: var(--spacing-lg);
    }

    h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-sm);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow);
    }

    .player-container {
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      position: relative;
    }

    input, button, select {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 1rem;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--light-text);
    }

    input {
      flex: 1;
      min-width: 200px;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      white-space: nowrap;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    button:active {
      transform: translateY(1px);
    }

    button.secondary {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
    }

    button.secondary:hover {
      background-color: var(--hover-bg);
    }

    button.danger {
      background-color: var(--error-color);
    }

    button.small {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.85rem;
    }

    video {
      width: 100%;
      border-radius: var(--border-radius-md);
      background-color: #000;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .url-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      width: 100%;
    }

    .history-container {
      width: 100%;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
      border-radius: var(--border-radius-sm);
      background-color: var(--input-bg);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item:hover {
      background-color: var(--hover-bg);
    }

    .history-url {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
      cursor: pointer;
      color: var(--secondary-text);
    }

    .history-url:hover {
      color: var(--light-text);
      text-decoration: underline;
    }

    .history-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .settings-container {
      width: 100%;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-label {
      font-weight: 500;
    }

    .error-container {
      width: 100%;
      padding: var(--spacing-md);
      background-color: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--error-color);
      border-radius: var(--border-radius-md);
      color: #ff9c9c;
      display: none;
      margin-top: var(--spacing-md);
    }

    .error-container.info {
      background-color: rgba(33, 150, 243, 0.1);
      border-color: #2196F3;
      color: #a7d8ff;
    }

    .error-container.info h3::before {
      content: "ℹ️ ";
    }

    .error-container pre {
      margin-top: var(--spacing-sm);
      background-color: rgba(0, 0, 0, 0.2);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      overflow-x: auto;
      font-size: 0.85rem;
    }

    .error-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .error-solution {
      background-color: rgba(255, 255, 255, 0.05);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      margin-top: var(--spacing-sm);
      font-size: 0.9rem;
    }

    .error-solution ul {
      margin-left: var(--spacing-md);
      margin-top: var(--spacing-xs);
    }

    .recovery-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: orange;
      margin-right: 5px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--spacing-md);
      overflow-x: auto;
    }

    .tab {
      padding: var(--spacing-sm) var(--spacing-md);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      font-weight: 500;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    .tab-content {
      display: none;
      width: 100%;
    }

    .tab-content.active {
      display: block;
    }

    .stream-quality {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--input-bg);
      border-radius: var(--border-radius-sm);
    }

    .stream-quality p {
      margin-bottom: var(--spacing-xs);
    }

    .player-clock {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      font-size: 0.9rem;
      z-index: 5;
      font-family: monospace;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .player-clock .clock-icon {
      opacity: 0.8;
      font-size: 0.8rem;
    }

    footer {
      text-align: center;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-md);
      color: var(--secondary-text);
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      .url-controls {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .controls {
        flex-direction: column;
      }
      
      input {
        width: 100%;
      }
      
      .history-actions {
        flex-wrap: wrap;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Trình phát M3U8 - Test URL</h1>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="controls">
        <div class="url-controls">
          <input type="text" id="m3u8-url" placeholder="Dán URL .m3u8 vào đây" />
          <button onclick="loadStream()">Phát</button>
          <button class="secondary" onclick="copyUrl()">Sao chép</button>
          <button class="secondary" onclick="toggleSettings()">Cài đặt</button>
        </div>
      </div>
      
      <div class="player-container">
        <video id="video" controls></video>
        <div class="player-clock">
          <span class="clock-icon">⏱</span>
          <span id="vn-clock">--:--:--</span>
        </div>
      </div>
    </div>

    <div class="error-container" id="error-container">
      <h3>Lỗi phát sinh:</h3>
      <div id="error-details"></div>
      <div class="error-solution" id="error-solution"></div>
      <div class="error-actions">
        <button onclick="recoverStream()">Thử khắc phục</button>
        <button class="secondary" onclick="changeSettings()">Đổi cài đặt</button>
        <button id="dismiss-error-btn" class="secondary" onclick="hideError()" style="display: none;">Bỏ qua</button>
        <button id="ignore-error-btn" class="secondary" onclick="ignoreErrorAndContinue()" style="display: none;">Tiếp tục phát</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('history')">Lịch sử</div>
      <div class="tab" onclick="switchTab('info')">Thông tin Stream</div>
      <div class="tab" onclick="switchTab('settings')">Cài đặt</div>
    </div>

    <div class="tab-content active" id="history-tab">
      <div class="card history-container">
        <div class="history-header">
          <h3>Lịch sử URL</h3>
          <button class="danger small" onclick="clearHistory()">Xóa lịch sử</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <div class="tab-content" id="info-tab">
      <div class="card history-container">
        <h3>Thông tin Stream</h3>
        <div id="stream-info">
          <p>Chưa có thông tin stream nào được tải.</p>
        </div>
      </div>
    </div>

    <div class="tab-content" id="settings-tab">
      <div class="card settings-container">
        <h3>Cài đặt</h3>
        <div class="setting-row">
          <span class="setting-label">Tự động phát</span>
          <input type="checkbox" id="autoplay-setting" checked>
        </div>
        <div class="setting-row">
          <span class="setting-label">Lưu lịch sử</span>
          <input type="checkbox" id="save-history-setting" checked>
        </div>
        <div class="setting-row">
          <span class="setting-label">Phiên bản HLS.js</span>
          <select id="hls-version">
            <option value="latest">Latest</option>
            <option value="1.4.10">1.4.10</option>
            <option value="1.3.5">1.3.5</option>
            <option value="1.2.9">1.2.9</option>
          </select>
        </div>
      </div>
    </div>
    
    <footer>
      Công cụ phát triển & kiểm tra URL M3U8 by khanhvo1592@gmail.com
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    let currentHls = null;
    
    // Khởi tạo cài đặt
    let settings = {
      autoplay: true,
      saveHistory: true,
      hlsVersion: 'latest'
    };
    
    // Khởi tạo lịch sử
    let history = JSON.parse(localStorage.getItem('m3u8History')) || [];
    
    // Đồng hồ hệ thống
    function updateClock() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0'); 
      const seconds = now.getSeconds().toString().padStart(2, '0');
      
      document.getElementById('vn-clock').textContent = `${hours}:${minutes}:${seconds}`;
    }
    
    // Cập nhật đồng hồ mỗi giây
    setInterval(updateClock, 1000);
    updateClock(); // Cập nhật ngay lập tức
    
    // Hiển thị lịch sử
    function renderHistory() {
      const historyList = document.getElementById('history-list');
      historyList.innerHTML = '';
      
      if (history.length === 0) {
        historyList.innerHTML = '<p style="padding: 10px;">Chưa có URL nào trong lịch sử.</p>';
        return;
      }
      
      history.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        const urlSpan = document.createElement('div');
        urlSpan.className = 'history-url';
        urlSpan.textContent = url;
        urlSpan.title = url;
        urlSpan.onclick = () => {
          document.getElementById('m3u8-url').value = url;
          loadStream();
        };
        
        const actions = document.createElement('div');
        actions.className = 'history-actions';
        
        const playBtn = document.createElement('button');
        playBtn.className = 'small';
        playBtn.textContent = 'Phát';
        playBtn.onclick = () => {
          document.getElementById('m3u8-url').value = url;
          loadStream();
        };
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'small secondary';
        copyBtn.textContent = 'Sao chép';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(url);
        };
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'small danger';
        removeBtn.textContent = 'Xóa';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          history.splice(index, 1);
          saveHistory();
          renderHistory();
        };
        
        actions.appendChild(playBtn);
        actions.appendChild(copyBtn);
        actions.appendChild(removeBtn);
        
        item.appendChild(urlSpan);
        item.appendChild(actions);
        historyList.appendChild(item);
      });
    }
    
    // Lưu lịch sử
    function saveHistory() {
      localStorage.setItem('m3u8History', JSON.stringify(history));
    }
    
    // Thêm URL vào lịch sử
    function addToHistory(url) {
      if (!settings.saveHistory) return;
      
      // Xóa URL này nếu đã tồn tại
      history = history.filter(item => item !== url);
      
      // Thêm vào đầu danh sách
      history.unshift(url);
      
      // Giới hạn số lượng URL trong lịch sử
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      saveHistory();
      renderHistory();
    }
    
    // Xóa toàn bộ lịch sử
    function clearHistory() {
      if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử không?')) {
        history = [];
        saveHistory();
        renderHistory();
      }
    }
    
    // Sao chép URL vào clipboard
    function copyUrl() {
      const url = document.getElementById('m3u8-url').value.trim();
      if (url) {
        copyToClipboard(url);
      } else {
        alert('Không có URL để sao chép!');
      }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          alert('Đã sao chép URL vào clipboard!');
        })
        .catch(err => {
          console.error('Không thể sao chép URL: ', err);
          alert('Không thể sao chép URL. Vui lòng thử lại.');
        });
    }
    
    // Hiển thị/ẩn cài đặt
    function toggleSettings() {
      switchTab('settings');
    }
    
    // Cập nhật cài đặt
    function updateSettings() {
      settings.autoplay = document.getElementById('autoplay-setting').checked;
      settings.saveHistory = document.getElementById('save-history-setting').checked;
      settings.hlsVersion = document.getElementById('hls-version').value;
      
      localStorage.setItem('m3u8Settings', JSON.stringify(settings));
      
      // Cập nhật thư viện HLS.js nếu phiên bản thay đổi
      if (settings.hlsVersion !== 'latest') {
        const script = document.querySelector('script[src*="hls.js"]');
        script.src = `https://cdn.jsdelivr.net/npm/hls.js@${settings.hlsVersion}`;
      }
    }
    
    // Tải cài đặt từ localStorage
    function loadSettings() {
      const savedSettings = JSON.parse(localStorage.getItem('m3u8Settings'));
      if (savedSettings) {
        settings = {...settings, ...savedSettings};
      }
      
      document.getElementById('autoplay-setting').checked = settings.autoplay;
      document.getElementById('save-history-setting').checked = settings.saveHistory;
      document.getElementById('hls-version').value = settings.hlsVersion;
    }
    
    // Thêm hàm mới để bỏ qua lỗi và tiếp tục phát
    function ignoreErrorAndContinue() {
      hideError();
      
      // Đánh dấu là đã bỏ qua lỗi để không hiển thị lại
      window._ignoredErrorsForCurrentStream = true;
      
      // Thử phát lại video nếu chưa phát
      if (video.paused) {
        video.play().catch(e => {
          console.warn('Không thể phát video sau khi bỏ qua lỗi: ', e);
        });
      }
    }

    // Hiển thị thông tin lỗi
    function showError(title, details) {
      // Nếu đã bỏ qua lỗi cho stream hiện tại, không hiển thị lại
      if (window._ignoredErrorsForCurrentStream) {
        console.log('Bỏ qua hiển thị lỗi vì người dùng đã chọn tiếp tục phát');
        return;
      }
      
      const errorContainer = document.getElementById('error-container');
      const errorDetails = document.getElementById('error-details');
      const errorSolution = document.getElementById('error-solution');
      const dismissBtn = document.getElementById('dismiss-error-btn');
      const ignoreBtn = document.getElementById('ignore-error-btn');
      
      errorContainer.style.display = 'block';
      errorDetails.innerHTML = `<p><strong>${title}</strong></p>`;
      
      if (details) {
        errorDetails.innerHTML += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
      }

      // Hiển thị gợi ý giải pháp dựa trên loại lỗi
      let solutionHtml = '';
      
      // Kiểm tra xem video có đang phát không
      const isVideoPlaying = !video.paused && video.currentTime > 0;
      
      // Hiển thị nút 'Tiếp tục phát' nếu video đang phát dù có lỗi
      ignoreBtn.style.display = isVideoPlaying ? 'block' : 'none';
      
      if (details && details.type === 'info') {
        // Thông báo thông tin, không phải lỗi
        errorContainer.classList.add('info');
        errorSolution.innerHTML = '';
        dismissBtn.style.display = 'block'; // Hiển thị nút bỏ qua cho thông tin
        ignoreBtn.style.display = 'none';
        return;
      } else {
        // Khôi phục style lỗi
        errorContainer.classList.remove('info');
        dismissBtn.style.display = 'none';
      }
      
      if (details && details.type === 'mediaError') {
        if (details.details === 'bufferAppendError' && details.sourceBufferName === 'video') {
          solutionHtml = `
            <p><strong>Nguyên nhân và giải pháp:</strong></p>
            <ul>
              <li>Lỗi "Attempting to append to the video SourceBuffer, but it does not exist" thường xảy ra với stream chỉ chứa audio mà không có video.</li>
              <li>Hệ thống sẽ tự động thử phát audio mà không cần video.</li>
              <li>Nếu cần, bạn có thể thử chuyển sang phiên bản HLS.js cũ hơn (như phiên bản 1.3.5).</li>
              <li>Đôi khi stream yêu cầu sử dụng trình phát cụ thể, thử phát trực tiếp trên trình duyệt Safari hoặc iOS.</li>
            </ul>
          `;
        } else {
          solutionHtml = `
            <p><strong>Gợi ý giải pháp:</strong></p>
            <ul>
              <li>Kiểm tra lại URL stream (có thể URL đã hết hạn)</li>
              <li>Kiểm tra kết nối mạng của bạn</li>
              <li>Stream có thể yêu cầu quyền truy cập (CORS/cookie)</li>
              <li>Thử chuyển sang phiên bản HLS.js khác</li>
              <li>Liên hệ quản trị viên nếu đây là stream nội bộ</li>
            </ul>
          `;
        }
        
        // Tự động thử khôi phục với lỗi media
        setTimeout(() => recoverStream(details), 2000);
      } else if (details && details.type === Hls.ErrorTypes.NETWORK_ERROR) {
        solutionHtml = `
          <p><strong>Gợi ý giải pháp:</strong></p>
          <ul>
            <li>Kiểm tra kết nối internet của bạn</li>
            <li>Kiểm tra URL có chính xác không</li>
            <li>Server stream có thể đang quá tải</li>
            <li>Có thể stream yêu cầu xác thực</li>
            <li>Thử truy cập vào URL trực tiếp để xem lỗi chi tiết</li>
          </ul>
        `;
      } else {
        solutionHtml = `
          <p><strong>Gợi ý chung:</strong></p>
          <ul>
            <li>Làm mới trang và thử lại</li>
            <li>Kiểm tra URL stream có đúng định dạng .m3u8 không</li>
            <li>Thử mở stream trên các trình phát khác</li>
          </ul>
        `;
      }
      
      errorSolution.innerHTML = solutionHtml;
    }
    
    // Ẩn thông tin lỗi
    function hideError() {
      const errorContainer = document.getElementById('error-container');
      errorContainer.style.display = 'none';
      errorContainer.classList.remove('info');
    }

    // Mở tab cài đặt
    function changeSettings() {
      switchTab('settings');
    }

    // Thử khắc phục stream
    let recoveryAttempts = 0;
    const MAX_RECOVERY_ATTEMPTS = 3;

    function recoverStream(errorData) {
      const url = document.getElementById('m3u8-url').value.trim();
      if (!url) return;
      
      if (recoveryAttempts >= MAX_RECOVERY_ATTEMPTS) {
        showError("Đã thử khắc phục nhiều lần không thành công", 
          {message: "Vui lòng kiểm tra lại URL hoặc thử các cài đặt khác"});
        recoveryAttempts = 0;
        return;
      }
      
      recoveryAttempts++;
      
      // Thêm indicator đang khôi phục
      const errorDetailsEl = document.getElementById('error-details');
      errorDetailsEl.innerHTML += `
        <p style="margin-top: 10px;">
          <span class="recovery-indicator"></span>
          Đang thử khắc phục lần ${recoveryAttempts}/${MAX_RECOVERY_ATTEMPTS}...
        </p>
      `;
      
      // Hủy instance hiện tại
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      // Khởi tạo lại với cài đặt khác
      let hlsConfig = {
        debug: true,
        // Các cài đặt để tăng khả năng phục hồi
        maxBufferLength: 30,
        maxMaxBufferLength: 60,
        maxBufferSize: 60 * 1000 * 1000, // 60MB
        maxBufferHole: 0.5,
        lowLatencyMode: false,
        // Số lần thử lại
        manifestLoadingMaxRetry: 6,
        manifestLoadingRetryDelay: 1000,
        levelLoadingMaxRetry: 6,
        levelLoadingRetryDelay: 1000,
        fragLoadingMaxRetry: 6,
        fragLoadingRetryDelay: 1000,
        // Tắt một số tính năng
        enableWorker: false
      };
      
      // Nếu gặp lỗi về video SourceBuffer, thêm các tùy chọn đặc biệt
      if (errorData && errorData.details === 'bufferAppendError' && 
          errorData.sourceBufferName === 'video') {
            
        // Cấu hình đặc biệt cho stream audio-only
        hlsConfig = {
          ...hlsConfig,
          enableWorker: false, // Tắt worker để dễ debug
          // Có thể là stream audio-only, cố gắng xử lý
          progressive: false,
          lowLatencyMode: false,
          backBufferLength: 90,
          appendErrorMaxRetry: 15,
          forceKeyFrameOnDiscontinuity: false,
          // Thử phát mà không cần video track
          preferManagedMediaSource: false,
          ignoreSingleMediaStreamCodecError: true
        };
        
        // Bật chế độ stream audio-only trong cài đặt
        const audioOnlyCheckbox = document.getElementById('audio-only-mode-setting');
        if (audioOnlyCheckbox) {
          audioOnlyCheckbox.checked = true;
          updateAdvancedSettings();
        }
        
        // Cập nhật thông tin
        console.log('Áp dụng cấu hình đặc biệt cho stream có thể là audio-only');
      }
      
      // Áp dụng cài đặt nâng cao
      hlsConfig = applyAdvancedSettings(hlsConfig);
      console.log('Khắc phục với cấu hình:', hlsConfig);
      
      try {
        if (Hls.isSupported()) {
          const hls = new Hls(hlsConfig);
          currentHls = hls;
          
          hls.loadSource(url);
          hls.attachMedia(video);
          
          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            hideError();
            recoveryAttempts = 0;
            
            if (settings.autoplay) {
              video.play().catch(e => {
                console.warn('Không thể tự động phát: ', e);
              });
            }
            
            updateStreamInfo(hls.manifest);
          });
          
          // Xử lý sự kiện phục hồi lỗi media
          hls.on(Hls.Events.ERROR, function (event, data) {
            console.error('HLS error during recovery:', data);
            
            // Kiểm tra nếu video đang phát, không hiển thị lỗi cho một số lỗi không nghiêm trọng
            if (data.details === "bufferAppendError" && !video.paused && video.currentTime > 0) {
              console.log('Bỏ qua lỗi bufferAppendError vì stream vẫn đang phát bình thường');
              return;
            }
            
            // Thử phục hồi lỗi media tự động
            if (data.fatal && data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              console.log('Trying to recover from media error:', data.details);
              
              if (data.details === "bufferStalledError") {
                // Khắc phục lỗi buffer stalled
                console.log('Trying to seek slightly forward to recover from stalled buffer');
                video.currentTime += 0.1;
                hls.recoverMediaError();
              } else if (data.details === Hls.ErrorDetails.BUFFER_APPEND_ERROR) {
                console.log('Trying to recover from buffer append error...');
                
                // Thử phát với cài đặt khác
                setTimeout(() => {
                  hls.recoverMediaError();
                  
                  // Nếu không thành công, thử tải lại với cấu hình audio-only
                  setTimeout(() => {
                    if (video.paused) {
                      console.log('Vẫn bị lỗi sau khi thử phục hồi, áp dụng chế độ audio-only');
                      // Bật tùy chọn audio-only
                      const audioOnlyCheckbox = document.getElementById('audio-only-mode-setting');
                      if (audioOnlyCheckbox) {
                        audioOnlyCheckbox.checked = true;
                        updateAdvancedSettings();
                        loadStream(); // Tải lại stream
                      }
                    }
                  }, 2000);
                }, 500);
              } else {
                console.log('Trying to recover from media error...');
                hls.recoverMediaError();
              }
            }
            
            // Nếu lỗi mạng nghiêm trọng và đã hết số lần thử, hiển thị lỗi
            if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR && recoveryAttempts >= MAX_RECOVERY_ATTEMPTS) {
              let errorMsg = 'Lỗi mạng khi tải stream.';
              let details = {
                type: data.type,
                details: data.details,
                url: data.context ? data.context.url : 'unknown',
                response: data.response ? 
                  { code: data.response.code, text: data.response.text } : 'Không có phản hồi'
              };
              
              showError(errorMsg, details);
            }
          });

          // Thêm báo cáo phục hồi thành công
          hls.on(Hls.Events.FRAG_BUFFERED, function() {
            console.log('Fragment buffered, phục hồi có thể đã thành công');
            hideError();
            recoveryAttempts = 0;
          });
        }
      } catch (e) {
        console.error('Error during recovery:', e);
        showError('Lỗi không thể khắc phục', {message: e.message});
      }
    }
    
    // Bắt sự kiện thay đổi cài đặt
    document.getElementById('autoplay-setting').addEventListener('change', updateSettings);
    document.getElementById('save-history-setting').addEventListener('change', updateSettings);
    document.getElementById('hls-version').addEventListener('change', updateSettings);
    
    // Khởi tạo
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      renderHistory();
      addAdvancedSettings();
      
      // Thêm theo dõi sự kiện để xử lý stream phát thành công
      video.addEventListener('playing', function() {
        // Nếu video đang phát thành công, ẩn thông báo lỗi
        console.log('Video đang phát thành công, ẩn thông báo lỗi nếu có');
        hideError();
        
        // Đánh dấu đã phục hồi thành công
        recoveryAttempts = 0;
      });
      
      // Kiểm tra URL trong hash (nếu có)
      const hashUrl = window.location.hash.slice(1);
      if (hashUrl) {
        try {
          const decodedUrl = decodeURIComponent(hashUrl);
          document.getElementById('m3u8-url').value = decodedUrl;
          loadStream();
        } catch (e) {
          console.error('Không thể giải mã URL từ hash:', e);
        }
      }

      // Bắt sự kiện nhấn Enter trong input
      document.getElementById('m3u8-url').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
          loadStream();
        }
      });
    });
    
    // Cập nhật hash khi tải stream
    function updateUrlHash(url) {
      if (url) {
        window.location.hash = encodeURIComponent(url);
      }
    }

    // Chuyển đổi tab
    function switchTab(tabName) {
      // Xóa trạng thái active cho tất cả tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Thêm active cho tab được chọn
      document.querySelector(`.tab:nth-child(${tabName === 'history' ? 1 : (tabName === 'info' ? 2 : 3)})`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Cập nhật thông tin stream
    function updateStreamInfo(manifest) {
      const streamInfo = document.getElementById('stream-info');
      
      if (!manifest || !manifest.levels) {
        streamInfo.innerHTML = '<p>Không có thông tin stream.</p>';
        return;
      }
      
      let infoHTML = '<div>';
      
      infoHTML += `<p><strong>Số lượng chất lượng:</strong> ${manifest.levels.length}</p>`;
      
      manifest.levels.forEach((level, index) => {
        infoHTML += `
          <div class="stream-quality">
            <p><strong>Chất lượng #${index + 1}:</strong></p>
            <p>Độ phân giải: ${level.width}x${level.height}</p>
            <p>Bitrate: ${Math.round(level.bitrate / 1000)} kbps</p>
            <p>Codec: ${level.codecSet || 'Không rõ'}</p>
          </div>
        `;
      });
      
      infoHTML += '</div>';
      streamInfo.innerHTML = infoHTML;
    }

    function loadStream() {
      // Hủy instance HLS hiện tại nếu có
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      // Reset số lần thử khôi phục
      recoveryAttempts = 0;
      
      // Đặt lại cờ bỏ qua lỗi khi tải stream mới
      window._ignoredErrorsForCurrentStream = false;
      
      // Đặt lại biến theo dõi kiểm tra video đã bắt đầu
      video._checkStarted = false;
      
      const url = document.getElementById('m3u8-url').value.trim();
      if (!url) {
        alert('Vui lòng nhập URL .m3u8');
        return;
      }
      
      // Ẩn thông báo lỗi cũ
      hideError();
      
      // Cập nhật thông tin stream
      document.getElementById('stream-info').innerHTML = '<p>Đang tải thông tin stream...</p>';
      
      // Thêm vào lịch sử
      addToHistory(url);
      
      // Cập nhật hash
      updateUrlHash(url);

      if (Hls.isSupported()) {
        // Tạo cấu hình nâng cao để giải quyết các vấn đề phổ biến
        // đặc biệt là vấn đề "bufferAppendError"
        const hlsConfig = {
          debug: true,
          // Cấu hình buffer
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          maxBufferSize: 60 * 1000 * 1000, // 60MB
          // Tối ưu cho stream audio-only
          appendErrorMaxRetry: 10, // Số lần thử lại tối đa khi gặp lỗi append
          liveSyncDuration: 3, // Giảm độ trễ
          liveMaxLatencyDuration: 10,
          backBufferLength: 90,
          // Cài đặt để tránh lỗi khi làm việc với các loại codec khác nhau
          ignoreSingleMediaStreamCodecError: true,
          // Cài đặt thử lại khi gặp lỗi
          manifestLoadingMaxRetry: 4,
          manifestLoadingRetryDelay: 1000,
          // Tắt một số tính năng có thể gây lỗi
          enableWorker: false, // Tắt worker để tránh lỗi với một số stream
          // Xử lý đặc biệt với các stream audio-only
          altAudioCodec: 'mp4a.40.2'
        };
        
        // Áp dụng cài đặt nâng cao nếu có
        const finalConfig = applyAdvancedSettings(hlsConfig);
        console.log('Sử dụng cấu hình HLS:', finalConfig);
        
        const hls = new Hls(finalConfig);
        currentHls = hls;
        
        // Thêm sự kiện xử lý manifest đã tải
        hls.on(Hls.Events.MANIFEST_LOADED, function(event, data) {
          console.log('Manifest loaded:', data);
          
          // Kiểm tra xem manifest có chứa video track hay không
          const hasVideo = data.levels.some(level => 
            level.videoCodec !== undefined || 
            (level.codecSet && level.codecSet.toLowerCase().includes('avc'))
          );
          
          if (!hasVideo) {
            console.log('Phát hiện stream chỉ chứa audio (không có video). Áp dụng cấu hình đặc biệt.');
            // Thêm một class để xử lý giao diện cho stream audio-only
            video.classList.add('audio-only-stream');
            
            // Thông báo cho người dùng
            showError('Thông báo: Stream chỉ chứa audio', {
              type: 'info',
              message: 'Stream này chỉ chứa audio mà không có video. Player sẽ tự động điều chỉnh để phát audio.'
            });
            
            // Bật tùy chọn đặc biệt cho stream audio-only
            try {
              hls.audioTracks.forEach(track => {
                console.log('Tìm thấy audio track:', track);
              });
              
              // Thử tắt video track nếu có thể
              hls.audioTrack = 0;
              console.log('Đã chọn audio track đầu tiên');
            } catch (e) {
              console.error('Lỗi khi cố gắng xử lý audio track:', e);
            }
          } else {
            video.classList.remove('audio-only-stream');
          }
        });
        
        // Sự kiện xử lý hình ảnh đầu tiên được render
        hls.on(Hls.Events.FRAG_BUFFERED, function() {
          // Ẩn thông báo lỗi khi fragment đầu tiên được buffer thành công
          hideError();
        });
        
        hls.loadSource(url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
          if (settings.autoplay) {
            video.play().catch(e => {
              console.warn('Không thể tự động phát: ', e);
              showError('Thông báo: Cần tương tác người dùng', {
                type: 'info',
                message: 'Hầu hết các trình duyệt hiện đại yêu cầu tương tác người dùng trước khi tự động phát media có âm thanh. Đây là chính sách bảo vệ người dùng, không phải lỗi. Vui lòng nhấn nút "Play" trên video để bắt đầu phát.'
              });
            });
          }
          
          updateStreamInfo(hls.manifest);
        });
        
        hls.on(Hls.Events.ERROR, function (event, data) {
          console.error('HLS error:', data);
          
          let errorMsg = 'Không thể phát luồng HLS.';
          let details = null;
          
          // Kiểm tra xem video đã phát được chưa
          const isVideoActuallyPlaying = !video.paused && video.currentTime > 0;
          
          // Bỏ qua lỗi bufferAppendError nếu video vẫn đang phát
          if (data.details === "bufferAppendError" && isVideoActuallyPlaying) {
            console.log('Bỏ qua lỗi bufferAppendError vì stream vẫn đang phát bình thường');
            return;
          }
          
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                errorMsg = 'Lỗi mạng khi tải stream.';
                details = {
                  type: data.type,
                  details: data.details,
                  url: data.context ? data.context.url : 'unknown',
                  response: data.response ? 
                    { code: data.response.code, text: data.response.text } : 'Không có phản hồi'
                };
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                if (data.details === "bufferAppendError") {
                  // Xử lý đặc biệt cho lỗi bufferAppendError
                  if (data.sourceBufferName === "video") {
                    errorMsg = 'Phát hiện stream có thể chỉ chứa audio.';
                    console.log('Đang thử cấu hình đặc biệt cho stream chỉ chứa audio...');
                    
                    // Tự động phục hồi lỗi này mà không hiển thị thông báo
                    setTimeout(() => {
                      hls.recoverMediaError();
                      
                      // Sau khi thử khắc phục, hãy kiểm tra xem video có đang phát không
                      setTimeout(() => {
                        if (!video.paused && video.currentTime > 0) {
                          hideError();
                        }
                      }, 1000);
                    }, 10);
                    
                    // Người dùng có thể vẫn thấy stream phát bình thường
                    details = {
                      type: 'info',
                      message: 'Stream có thể chỉ chứa audio mà không có video. Nếu bạn vẫn nghe được âm thanh, hãy bỏ qua thông báo này.'
                    };
                  } else {
                    errorMsg = 'Lỗi khi xử lý stream.';
                    details = {
                      type: 'mediaError',
                      details: data.details,
                      sourceBufferName: data.sourceBufferName || 'unknown'
                    };
                  }
                } else {
                  errorMsg = 'Lỗi media. Stream không hợp lệ hoặc bị hỏng.';
                  details = {
                    type: 'mediaError',
                    details: data.details,
                    sourceBufferName: data.sourceBufferName || 'unknown'
                  };
                }
                break;
              default:
                errorMsg = 'Lỗi không xác định.';
                details = {
                  type: data.type,
                  details: data.details
                };
                break;
            }
            
            // Hiển thị lỗi chỉ khi stream không thực sự phát được
            if (!isVideoActuallyPlaying) {
              showError(errorMsg, details);
            }
            
            // Tự động thử khôi phục lỗi media
            if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              console.log('Trying to recover from media error...');
              hls.recoverMediaError();
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', function () {
          if (settings.autoplay) {
            video.play().catch(e => {
              console.warn('Không thể tự động phát: ', e);
              showError('Thông báo: Cần tương tác người dùng', {
                type: 'info',
                message: 'Hầu hết các trình duyệt hiện đại yêu cầu tương tác người dùng trước khi tự động phát media có âm thanh. Đây là chính sách bảo vệ người dùng, không phải lỗi. Vui lòng nhấn nút "Play" trên video để bắt đầu phát.'
              });
            });
          }
          document.getElementById('stream-info').innerHTML = 
            '<p>Đang sử dụng trình phát HLS tích hợp trình duyệt. Thông tin chi tiết không khả dụng.</p>';
        });
        
        video.addEventListener('error', function(e) {
          console.error('Video error:', video.error);
          showError('Không thể phát video', {
            code: video.error ? video.error.code : 'Không rõ',
            message: video.error ? video.error.message : 'Không rõ'
          });
        });
      } else {
        showError('Trình duyệt không hỗ trợ HLS.');
      }
    }

    // Thêm bộ đếm thời gian để kiểm tra xem video có thực sự đang phát không
    function checkIfVideoIsPlaying() {
      const lastTime = video.currentTime;
      
      setTimeout(() => {
        // Nếu thời gian hiện tại đã tăng, video đang phát
        if (video.currentTime > lastTime + 0.5 && !video.paused) {
          console.log('Video đang phát bình thường, ẩn thông báo lỗi nếu có');
          hideError();
        }
      }, 2000);
    }
    
    // Bắt đầu kiểm tra sau khi video bắt đầu chạy
    video.addEventListener('timeupdate', function() {
      // Chỉ chạy kiểm tra một lần khi video bắt đầu phát
      if (video.currentTime > 0.5 && !video._checkStarted) {
        video._checkStarted = true;
        checkIfVideoIsPlaying();
      }
    });
    
    // Thêm các tùy chọn nâng cao vào cài đặt
    // Thêm cài đặt mới
    const settingContainer = document.querySelector('.settings-container');
    
    // Thêm phần tùy chọn nâng cao vào trang
    function addAdvancedSettings() {
      // Tạo phần tử mới cho cài đặt nâng cao
      const advancedSection = document.createElement('div');
      advancedSection.innerHTML = `
        <h3 style="margin-top: 20px;">Cài đặt nâng cao</h3>
        <div class="setting-row">
          <span class="setting-label">Tắt Worker (giúp với lỗi bufferAppendError)</span>
          <input type="checkbox" id="disable-worker-setting">
        </div>
        <div class="setting-row">
          <span class="setting-label">Chế độ stream chỉ có audio</span>
          <input type="checkbox" id="audio-only-mode-setting">
        </div>
        <div class="setting-row">
          <span class="setting-label">Số lần thử lại tối đa</span>
          <select id="retry-attempts-setting">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
          </select>
        </div>
      `;
      
      // Thêm vào trang
      settingContainer.appendChild(advancedSection);
      
      // Thêm sự kiện cho các cài đặt mới
      document.getElementById('disable-worker-setting').addEventListener('change', updateAdvancedSettings);
      document.getElementById('audio-only-mode-setting').addEventListener('change', updateAdvancedSettings);
      document.getElementById('retry-attempts-setting').addEventListener('change', updateAdvancedSettings);
      
      // Tải cài đặt nâng cao từ localStorage nếu có
      loadAdvancedSettings();
    }
    
    // Tải cài đặt nâng cao
    function loadAdvancedSettings() {
      const savedAdvancedSettings = JSON.parse(localStorage.getItem('m3u8AdvancedSettings'));
      if (savedAdvancedSettings) {
        document.getElementById('disable-worker-setting').checked = savedAdvancedSettings.disableWorker || false;
        document.getElementById('audio-only-mode-setting').checked = savedAdvancedSettings.audioOnlyMode || false;
        document.getElementById('retry-attempts-setting').value = savedAdvancedSettings.retryAttempts || "10";
      }
    }
    
    // Cập nhật cài đặt nâng cao
    function updateAdvancedSettings() {
      const advancedSettings = {
        disableWorker: document.getElementById('disable-worker-setting').checked,
        audioOnlyMode: document.getElementById('audio-only-mode-setting').checked,
        retryAttempts: document.getElementById('retry-attempts-setting').value
      };
      
      localStorage.setItem('m3u8AdvancedSettings', JSON.stringify(advancedSettings));
      console.log('Đã lưu cài đặt nâng cao:', advancedSettings);
    }
    
    // Áp dụng cài đặt nâng cao vào cấu hình HLS
    function applyAdvancedSettings(config) {
      const advancedSettings = JSON.parse(localStorage.getItem('m3u8AdvancedSettings')) || {};
      
      if (advancedSettings.disableWorker) {
        config.enableWorker = false;
      }
      
      if (advancedSettings.audioOnlyMode) {
        // Cài đặt đặc biệt cho stream audio-only
        config.appendErrorMaxRetry = 15;
        config.backBufferLength = 120;
        config.progressive = false;
        config.forceKeyFrameOnDiscontinuity = false;
      }
      
      if (advancedSettings.retryAttempts) {
        const retries = parseInt(advancedSettings.retryAttempts);
        config.manifestLoadingMaxRetry = retries;
        config.levelLoadingMaxRetry = retries;
        config.fragLoadingMaxRetry = retries;
        config.appendErrorMaxRetry = retries;
      }
      
      return config;
    }
  </script>
</body>
</html>
